name: Build LooP ISO

on:
  release:
    types: [published]
  workflow_dispatch: # Adds a "Run Workflow" button for manual testing

jobs:
  build_iso:
    name: Build Live ISO
    runs-on: ubuntu-latest
    permissions:
      contents: write # Critical for uploading the ISO back to the release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # CRITICAL: Free up disk space. Live-build needs ~15GB+. 
      # Standard runners only have ~14GB free. This action clears ~30GB.
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false # Keep Docker, we need it!
          swap-storage: true

      - name: Build Builder Container
        run: |
          docker build -t loop-builder tools/iso/

      - name: Run Build (Privileged)
        run: |
          mkdir -p output
          # We run --privileged so the container can mount loopback devices for ISO creation
          docker run --privileged \
            -v ${{ github.workspace }}:/input \
            -v ${{ github.workspace }}/output:/output \
            loop-builder \
            /input /output/loop-os-${{ github.ref_name }}.iso

      - name: Upload ISO to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: output/loop-os-${{ github.ref_name }}.iso
