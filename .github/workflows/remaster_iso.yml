name: Build LooP ISO (Remaster)

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  remaster_iso:
    name: Remaster ISO
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Remastering requires uncompressing the ISO (3GB) + Chroot (4GB) + Build Artifacts.
      # Standard runners are tight. Freeing space is mandatory.
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Build Remaster Builder
        run: |
          docker build -t loop-remaster-builder tools/remaster/

      - name: Run Remastering Process (Privileged)
        run: |
          mkdir -p output
          # We execute the script directly from the mounted input volume
          # The script is self-contained and sets up its own internal workspace
          docker run --privileged \
            -v ${{ github.workspace }}:/input \
            -v ${{ github.workspace }}/output:/output \
            loop-remaster-builder \
            /input/tools/remaster/build_distro.sh \
            /input \
            /output/loop-os-${{ github.ref_name }}.iso

      - name: Upload ISO to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: output/loop-os-${{ github.ref_name }}.iso
